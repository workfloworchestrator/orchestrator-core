# Retriever SQL Snapshot Tests

This directory contains SQL snapshot tests for the retriever module. These tests lock the SQL structure generated by each retriever type.

## What Do These Tests Cover?

The tests verify SQL query structure for:

- **StructuredRetriever**: Basic entity retrieval with no text search
- **FuzzyRetriever**: Fuzzy text matching using PostgreSQL trigrams
- **SemanticRetriever**: Vector similarity search using pgvector
- **RrfHybridRetriever**: Reciprocal Rank Fusion combining semantic + fuzzy

Each retriever is tested:

1. **Basic query**: Default behavior without pagination
2. **Pagination query**: Cursor-based pagination logic

## How Snapshot Testing Works

### Normal Mode (Assert Against Snapshots)

```bash
pytest test/unit_tests/search/retrieval/retrievers/test_retrievers.py
```

In normal mode, tests:

1. Generate SQL from retrievers
2. Compare against stored snapshots in `sql_snapshots.json`
3. **Fail if SQL doesn't match** with a clear diff

### Record Mode (Update Snapshots)

```bash
pytest test/unit_tests/search/retrieval/retrievers/test_retrievers.py --record
```

In record mode, tests:

1. Generate SQL from retrievers
2. Save the SQL to `sql_snapshots.json`
3. Always pass (no assertions)

## When to Use Record Mode

Use `--record` when you:

- **Intentionally changed** retriever logic (pagination, scoring, etc.)
- Added new retriever tests
- Changed SQLAlchemy query generation

## Files in This Module

- `test_retrievers.py` - Main test file with all retriever tests
- `snapshot_helper.py` - Snapshot testing utilities
- `sql_snapshots.json` - Stored SQL snapshots (auto-generated)
- `README.md` - This file

## Adding New Tests

To add a new test:

```python
def test_new_feature(self, candidate_query, request):
    """Test description."""
    retriever = MyRetriever(params)
    query = retriever.apply(candidate_query)
    sql = compile_query_to_sql(query)

    assert_sql_matches_snapshot("MyRetriever.test_new_feature", sql, request)
```

Then record the snapshot:

```bash
pytest test/unit_tests/search/retrieval/retrievers/test_retrievers.py::TestMyRetriever::test_new_feature --record
```

## Limitations

These tests verify **SQL structure only**, not:

- ❌ Actual query execution
- ❌ Result correctness
- ❌ Edge cases with real data

For those, you would need integration tests.
