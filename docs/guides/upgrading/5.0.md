# 5.0 Upgrade Guide

In this document we describe important changes to be aware of when upgrading from `orchestrator-core` v4.x to v5.0.

## About 5.0

### Secret settings for sensitive URIs

In this release, three `AppSettings` fields that contain sensitive connection strings have been changed from plain types to Pydantic Secret subtypes. These URIs can contain credentials (e.g. database passwords, Redis auth tokens) that should not be leaked. By wrapping them in Secret types, Pydantic automatically masks their values when the settings object is logged, printed, serialized, or appears in tracebacks — replacing the actual value with `'**********'`. This provides better protection against accidental credential exposure in application logs and error reports.

The affected fields and their new types are:

| Field | Old Type | New Type |
|-------|----------|----------|
| `DATABASE_URI` | `PostgresDsn` | `SecretPostgresDsn` (`Secret[PostgresDsn]`) |
| `CACHE_URI` | `RedisDsn` | `SecretRedisDsn` (`Secret[RedisDsn]`) |
| `WEBSOCKET_BROADCASTER_URL` | `str` | `SecretStr` |

#### What changed

Previously, you could use these settings values directly:

```python
from orchestrator.settings import app_settings

# Old usage — no longer works
db_url = str(app_settings.DATABASE_URI)
redis_url = str(app_settings.CACHE_URI)
ws_url = app_settings.WEBSOCKET_BROADCASTER_URL
```

Now, you must call `.get_secret_value()` to retrieve the underlying value:

```python
from orchestrator.settings import app_settings

# New usage
db_url = str(app_settings.DATABASE_URI.get_secret_value())
redis_url = str(app_settings.CACHE_URI.get_secret_value())
ws_url = app_settings.WEBSOCKET_BROADCASTER_URL.get_secret_value()
```

#### What you need to do

Search your codebase for any direct references to `app_settings.DATABASE_URI`, `app_settings.CACHE_URI`, or `app_settings.WEBSOCKET_BROADCASTER_URL` (or via a `settings` parameter of type `AppSettings`). At each usage site, append `.get_secret_value()` to extract the actual value.

For example:

```python
# Before
config.set_main_option("sqlalchemy.url", str(app_settings.DATABASE_URI))
cache = create_redis_client(app_settings.CACHE_URI)
broadcaster_type = urlparse(app_settings.WEBSOCKET_BROADCASTER_URL).scheme

# After
config.set_main_option("sqlalchemy.url", str(app_settings.DATABASE_URI.get_secret_value()))
cache = create_redis_client(app_settings.CACHE_URI.get_secret_value())
broadcaster_type = urlparse(app_settings.WEBSOCKET_BROADCASTER_URL.get_secret_value()).scheme
```

If you assign to these fields in tests or configuration (e.g. overriding `DATABASE_URI` with a test database URL), wrap the value in the appropriate Secret type:

```python
from orchestrator.settings import SecretPostgresDsn, SecretRedisDsn, app_settings
from pydantic import SecretStr

# Before
app_settings.DATABASE_URI = db_uri

# After
app_settings.DATABASE_URI = SecretPostgresDsn(db_uri)
```
