# 5.0 Migration Guide

In this document we describe the steps that should be taken to migrate from the `orchestrator-core` settings exposure
mechanism (v4.x) to version 5.0.

---

## About 5.0

The `5.0` release introduces a restructured and secured way to expose application settings for inspection or debugging.
Key changes include:

- A new `expose_settings(settings_name, base_settings)` function that **requires explicit registration** of each
  `BaseSettings` class.
- Settings are now returned in a **structured schema** via `SettingsExposedSchema` and `SettingsEnvVariablesSchema`.
- **Sensitive values are now masked automatically**, including:
    - Any key containing `"secret"` or `"password"`
    - Instances of `SecretStr`
    - Instances of `PostgresDsn`

---

## Why is this breaking?

### Secret masking is now stricter

If you relied on viewing raw secret or password values, those are now **automatically masked** for safety.
However, this also means if you relied on using these values in your code, you will need to adjust your logic to handle
masked values.

Like so:

```python
from pydantic import BaseSettings, SecretStr


class MySettings(BaseSettings):
    secret_key: SecretStr = SecretStr("my_secret")
```

Using `secret_key` you will need to `get_secret_value()` to access the actual value:

```python
settings = MySettings()
print(settings.secret_key.get_secret_value())  # This will print "my_secret"
``` 

## Steps

Follow these steps to upgrade:

### 1. Update your settings exposure

Ensure you are using the new `expose_settings` to register your settings classes. For example:

```python
from orchestrator.services.settings_env_variables import expose_settings
from pydantic import BaseSettings, SecretStr


class MySettings(BaseSettings):
    secret_key: SecretStr = SecretStr("my_secret")


expose_settings("my_settings", MySettings)
```

### 2. Adjust your code for masked secrets

If your code previously accessed sensitive values directly, update it to use the `get_secret_value()`
method on `SecretStr` or similar types. For example:

```python
from pydantic import BaseSettings, SecretStr


class MySettings(BaseSettings):
    secret_key: SecretStr = SecretStr("my_secret")
```

Using `secret_key` you will need to `get_secret_value()` to access the actual value:

```python
settings = MySettings()
print(settings.secret_key.get_secret_value())  # This will print "my_secret"
``` 

### 3. Ensure your secrets are properly masked

Review your settings to ensure that any sensitive information is properly masked. If you have custom logic that relies
on the raw values of secrets, you will need to refactor it to accommodate the new masking behavior.

The new exposed settings are accessible via the `api/settings/expose` endpoint, which will return a structured JSON
response.
